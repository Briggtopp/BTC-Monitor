<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BTC Live Monitor">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="BTC Live Monitor">
    <meta name="theme-color" content="#10b981">
    <meta name="msapplication-TileColor" content="#10b981">
    
    <title>🚀 BTC Live Trading Monitor</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            gap: 15px;
        }

        .api-status {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .api-status.online {
            border-left: 4px solid #10b981;
        }

        .api-status.offline {
            border-left: 4px solid #ef4444;
        }

        .api-status.loading {
            border-left: 4px solid #f59e0b;
        }

        .mode-selector {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .mode-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mode-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .price-display {
            font-size: 3rem;
            font-weight: bold;
            color: #10b981;
            margin: 15px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .price-display.loading {
            color: #f59e0b;
            animation: pulse 2s infinite;
        }

        .price-display.error {
            color: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .crash-alert {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            animation: flashAlert 1s infinite;
            display: none;
        }

        .pump-alert {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            animation: flashAlert 1s infinite;
            display: none;
        }

        @keyframes flashAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .countdown-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .countdown-display {
            font-size: 2rem;
            font-weight: bold;
            color: #ef4444;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }

        .fed-schedule {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .fed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .fed-item.next {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            font-weight: 600;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-success { background: #10b981; }
        .btn-warning { background: #f59e0b; }
        .btn-danger { background: #ef4444; }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .install-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .debug-panel {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .api-info {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        .status-dot.loading {
            background: #f59e0b;
        }

        .retry-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .price-display { font-size: 2.2rem; }
            .grid { grid-template-columns: 1fr; }
            .container { padding: 8px; }
            .mode-buttons { flex-direction: column; }
            .api-status { flex-direction: column; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- API Status -->
        <div class="api-status loading" id="apiStatus">
            <div>
                <strong>📡 Live Data Feed</strong>
                <div class="api-info">
                    <div class="status-dot loading" id="statusDot"></div>
                    <span id="apiInfo">Verbinde zu API...</span>
                </div>
            </div>
            <div style="font-size: 0.8rem; color: #6b7280;">
                Letztes Update: <span id="lastApiUpdate">--:--</span>
            </div>
        </div>

        <!-- Debug Panel (only visible if needed) -->
        <div class="debug-panel" id="debugPanel" style="display: none;">
            <strong>🔧 Debug Info:</strong><br>
            <div id="debugLog">Initialisiere...</div>
            <button class="retry-btn" onclick="forceRetry()">🔄 Alle APIs erneut versuchen</button>
        </div>

        <!-- Installation Banner -->
        <div class="install-banner" id="installBanner">
            <div class="install-text">📱 Als App installieren für beste Erfahrung</div>
            <button class="install-btn btn" id="installBtn">Installieren</button>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <h3>🎯 Trading Modus wählen</h3>
            <div class="mode-buttons">
                <div class="mode-btn active" data-mode="bear">🐻 Bear Market Survival</div>
                <div class="mode-btn" data-mode="bull">🚀 Bull Run Tracker</div>
                <div class="mode-btn" data-mode="day">⚡ Day Trading</div>
                <div class="mode-btn" data-mode="hodl">💎 HODL Monitor</div>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header">
            <h1>🚀 BTC Live Trading Monitor</h1>
            <p id="modeDescription">Bear Market Survival - DCA & Accumulation Focus</p>
            <div class="price-display loading" id="btcPrice">Lade Live-Daten...</div>
            <div id="priceChange">Verbinde zu APIs...</div>
            
            <!-- Crash/Pump Alerts -->
            <div class="crash-alert" id="crashAlert">
                🚨 CRASH DETECTED! BTC fällt stark!
            </div>
            <div class="pump-alert" id="pumpAlert">
                🚀 PUMP DETECTED! BTC steigt stark!
            </div>
            
            <div class="button-row">
                <button class="btn btn-warning" id="pushBtn">🔔 Push aktivieren</button>
                <button class="btn btn-success" id="refreshBtn">🔄 Aktualisieren</button>
                <button class="btn" id="monitorBtn">⏸️ Pausieren</button>
                <button class="btn btn-danger" id="debugBtn">🔧 Debug</button>
            </div>
        </div>
        
        <!-- Fed Schedule -->
        <div class="countdown-container">
            <div class="countdown-title">🏛️ Fed Meeting Schedule 2025</div>
            <div class="countdown-display" id="nextFedCountdown">Wird geladen...</div>
            <div class="fed-schedule" id="fedSchedule">
                <!-- Wird dynamisch gefüllt -->
            </div>
        </div>
        
        <!-- Dynamic Content Grid -->
        <div class="grid" id="dynamicGrid">
            <div class="card">
                <div class="card-title">⏳ Lade Daten...</div>
                <p>Die Live-Daten werden geladen. Falls dies länger dauert, prüfen Sie die Debug-Informationen.</p>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentPrice = 0;
        let priceData = {};
        let fearGreedData = {};
        let pushEnabled = false;
        let isMonitoring = true;
        let currentMode = 'bear';
        let deferredPrompt;
        let apiOnline = false;
        let debugMode = false;
        let apiAttempts = 0;
        let maxRetries = 3;

        // Debug logging
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('debugLog');
            if (logEl) {
                logEl.innerHTML += `<br>[${timestamp}] ${message}`;
                logEl.scrollTop = logEl.scrollHeight;
            }
            console.log(`[BTC Monitor] ${message}`);
        }

        // Fed Meeting Dates 2025
        const FED_MEETINGS = [
            { date: new Date('2025-01-29T19:00:00Z'), desc: '29. Januar 2025' },
            { date: new Date('2025-03-19T18:00:00Z'), desc: '19. März 2025' },
            { date: new Date('2025-04-30T18:00:00Z'), desc: '30. April 2025' },
            { date: new Date('2025-06-18T18:00:00Z'), desc: '18. Juni 2025' },
            { date: new Date('2025-07-30T18:00:00Z'), desc: '30. Juli 2025' },
            { date: new Date('2025-09-17T18:00:00Z'), desc: '17. September 2025' },
            { date: new Date('2025-11-05T19:00:00Z'), desc: '5. November 2025' },
            { date: new Date('2025-12-17T19:00:00Z'), desc: '17. Dezember 2025' }
        ];

        // Multiple API endpoints with CORS proxies
        const API_ENDPOINTS = [
            {
                name: 'CoinGecko (Direct)',
                url: 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true&include_last_updated_at=true'
            },
            {
                name: 'CoinGecko (CORS Proxy)',
                url: 'https://cors-anywhere.herokuapp.com/https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true&include_last_updated_at=true'
            },
            {
                name: 'Binance (Direct)',
                url: 'https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT'
            },
            {
                name: 'CoinCap API',
                url: 'https://api.coincap.io/v2/assets/bitcoin'
            },
            {
                name: 'CryptoCompare',
                url: 'https://min-api.cryptocompare.com/data/price?fsym=BTC&tsyms=USD'
            }
        ];

        // Try multiple APIs in sequence
        async function fetchBTCPrice() {
            debugLog('Starte API-Abfrage...');
            apiAttempts++;
            
            for (let i = 0; i < API_ENDPOINTS.length; i++) {
                const endpoint = API_ENDPOINTS[i];
                debugLog(`Versuche ${endpoint.name}...`);
                
                try {
                    updateAPIStatus('loading', `Verbinde zu ${endpoint.name}...`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                    
                    const response = await fetch(endpoint.url, {
                        method: 'GET',
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    debugLog(`${endpoint.name} erfolgreich: ${JSON.stringify(data).substring(0, 100)}...`);
                    
                    // Parse different API formats
                    if (endpoint.name.includes('CoinGecko')) {
                        const btcData = data.bitcoin;
                        priceData = {
                            price: btcData.usd,
                            change24h: btcData.usd_24h_change,
                            volume24h: btcData.usd_24h_vol,
                            lastUpdated: btcData.last_updated_at * 1000,
                            source: endpoint.name
                        };
                    } else if (endpoint.name.includes('Binance')) {
                        priceData = {
                            price: parseFloat(data.lastPrice),
                            change24h: parseFloat(data.priceChangePercent),
                            volume24h: parseFloat(data.quoteVolume),
                            lastUpdated: Date.now(),
                            source: endpoint.name
                        };
                    } else if (endpoint.name.includes('CoinCap')) {
                        const btcData = data.data;
                        priceData = {
                            price: parseFloat(btcData.priceUsd),
                            change24h: parseFloat(btcData.changePercent24Hr),
                            volume24h: parseFloat(btcData.volumeUsd24Hr),
                            lastUpdated: Date.now(),
                            source: endpoint.name
                        };
                    } else if (endpoint.name.includes('CryptoCompare')) {
                        priceData = {
                            price: data.USD,
                            change24h: 0, // Not available in this endpoint
                            volume24h: 0, // Not available in this endpoint
                            lastUpdated: Date.now(),
                            source: endpoint.name
                        };
                    }
                    
                    currentPrice = priceData.price;
                    updatePriceDisplay();
                    updateAPIStatus('online', `${endpoint.name} • Live Data`);
                    debugLog(`Preis erfolgreich geladen: $${currentPrice.toLocaleString()}`);
                    
                    return true;
                    
                } catch (error) {
                    debugLog(`${endpoint.name} Fehler: ${error.message}`);
                    continue; // Try next API
                }
            }
            
            // All APIs failed
            debugLog(`Alle ${API_ENDPOINTS.length} APIs fehlgeschlagen nach ${apiAttempts} Versuchen`);
            updateAPIStatus('offline', 'Alle APIs offline - Prüfe Internetverbindung');
            
            // Show fallback price (last known or estimated)
            if (currentPrice === 0) {
                currentPrice = 119540; // Fallback price
                document.getElementById('btcPrice').textContent = `~$${currentPrice.toLocaleString()}`;
                document.getElementById('btcPrice').classList.add('error');
                document.getElementById('priceChange').textContent = 'Offline - Geschätzter Preis';
                debugLog('Zeige Fallback-Preis an');
            }
            
            return false;
        }

        // Fear & Greed with fallback
        async function fetchFearGreedIndex() {
            try {
                debugLog('Lade Fear & Greed Index...');
                const response = await fetch('https://api.alternative.me/fng/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`Fear & Greed API: ${response.status}`);
                }
                
                const data = await response.json();
                const fngData = data.data[0];
                
                fearGreedData = {
                    value: parseInt(fngData.value),
                    classification: fngData.value_classification,
                    timestamp: fngData.timestamp
                };
                
                debugLog(`Fear & Greed geladen: ${fearGreedData.value} (${fearGreedData.classification})`);
                return true;
                
            } catch (error) {
                debugLog(`Fear & Greed Fehler: ${error.message}`);
                // Fallback estimation
                fearGreedData = {
                    value: 45, // Neutral fallback
                    classification: 'Estimated',
                    timestamp: Date.now()
                };
                return false;
            }
        }

        function updatePriceDisplay() {
            const priceEl = document.getElementById('btcPrice');
            const changeEl = document.getElementById('priceChange');
            
            priceEl.textContent = `$${currentPrice.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            })}`;
            priceEl.classList.remove('loading', 'error');
            
            const change = priceData.change24h || 0;
            const source = priceData.source || 'Unknown';
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}% (24h) • ${source}`;
            changeEl.style.color = change >= 0 ? '#10b981' : '#ef4444';
            
            // Update content
            updateModeContent();
        }

        function updateAPIStatus(status, message = '') {
            const statusEl = document.getElementById('apiStatus');
            const dotEl = document.getElementById('statusDot');
            const infoEl = document.getElementById('apiInfo');
            const updateEl = document.getElementById('lastApiUpdate');
            
            statusEl.className = `api-status ${status}`;
            dotEl.className = `status-dot ${status}`;
            infoEl.textContent = message;
            
            const now = new Date();
            updateEl.textContent = now.toLocaleTimeString();
            
            if (status === 'online') {
                apiOnline = true;
            } else {
                apiOnline = false;
            }
        }

        // Force retry all APIs
        async function forceRetry() {
            debugLog('=== MANUELLER RETRY GESTARTET ===');
            apiAttempts = 0;
            document.getElementById('btcPrice').classList.add('loading');
            document.getElementById('priceChange').textContent = 'Versuche alle APIs erneut...';
            
            await fetchBTCPrice();
            await fetchFearGreedIndex();
            
            debugLog('=== RETRY ABGESCHLOSSEN ===');
        }

        // Fed Countdown
        function updateFedCountdown() {
            const now = new Date();
            const nextMeeting = FED_MEETINGS.find(meeting => meeting.date > now);
            
            if (nextMeeting) {
                const timeDiff = nextMeeting.date - now;
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('nextFedCountdown').textContent = 
                    `${days}d ${hours}h ${minutes}m bis ${nextMeeting.desc}`;
            }
            
            // Update Fed Schedule
            const scheduleEl = document.getElementById('fedSchedule');
            scheduleEl.innerHTML = '';
            
            FED_MEETINGS.slice(0, 4).forEach((meeting, index) => {
                const isNext = meeting === nextMeeting;
                const timeDiff = meeting.date - now;
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                
                const item = document.createElement('div');
                item.className = `fed-item ${isNext ? 'next' : ''}`;
                item.innerHTML = `
                    <span>📅 ${meeting.desc}</span>
                    <span>${days > 0 ? `in ${days} Tagen` : 'Vergangen'}</span>
                `;
                scheduleEl.appendChild(item);
            });
        }

        // Simple content for demonstration
        function updateModeContent() {
            const grid = document.getElementById('dynamicGrid');
            
            if (currentPrice === 0) {
                grid.innerHTML = `
                    <div class="card">
                        <div class="card-title">⚠️ Verbindungsproblem</div>
                        <div class="error-message">
                            <strong>API-Verbindung fehlgeschlagen</strong><br>
                            Mögliche Ursachen:<br>
                            • CORS-Blockierung durch Browser<br>
                            • Firewall/Proxy-Einstellungen<br>
                            • Temporärer API-Ausfall<br><br>
                            <button class="retry-btn" onclick="forceRetry()">🔄 Erneut versuchen</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Show basic info when price is available
            grid.innerHTML = `
                <div class="card">
                    <div class="card-title">💰 Live BTC Preis</div>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #10b981;">
                            $${currentPrice.toLocaleString()}
                        </div>
                        <div style="margin-top: 10px; color: #6b7280;">
                            24h Änderung: ${priceData.change24h ? priceData.change24h.toFixed(2) + '%' : 'N/A'}<br>
                            Quelle: ${priceData.source || 'Unknown'}<br>
                            <small>Letztes Update: ${priceData.lastUpdated ? new Date(priceData.lastUpdated).toLocaleTimeString() : 'N/A'}</small>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">😱 Fear & Greed Index</div>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">
                            ${fearGreedData.value || 45}
                        </div>
                        <div style="margin-top: 10px; color: #6b7280;">
                            ${fearGreedData.classification || 'Neutral'}<br>
                            <small>${fearGreedData.classification === 'Estimated' ? 'Geschätzt' : 'Alternative.me'}</small>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">📊 Status</div>
                    <div style="padding: 15px;">
                        <p><strong>API Status:</strong> ${apiOnline ? '🟢 Online' : '🔴 Offline'}</p>
                        <p><strong>Versuche:</strong> ${apiAttempts}</p>
                        <p><strong>Modus:</strong> ${currentMode.toUpperCase()}</p>
                        <p><strong>Monitoring:</strong> ${isMonitoring ? '▶️ Aktiv' : '⏸️ Pausiert'}</p>
                    </div>
                </div>
            `;
        }

        // Event Listeners
        document.getElementById('debugBtn').addEventListener('click', () => {
            debugMode = !debugMode;
            const panel = document.getElementById('debugPanel');
            panel.style.display = debugMode ? 'block' : 'none';
            
            if (debugMode) {
                debugLog('Debug-Modus aktiviert');
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = '🔄 Lade...';
            btn.disabled = true;
            
            await forceRetry();
            
            setTimeout(() => {
                btn.innerHTML = '🔄 Aktualisieren';
                btn.disabled = false;
            }, 2000);
        });

        document.getElementById('monitorBtn').addEventListener('click', () => {
            isMonitoring = !isMonitoring;
            const btn = document.getElementById('monitorBtn');
            
            if (isMonitoring) {
                btn.innerHTML = '⏸️ Pausieren';
                btn.className = 'btn btn-warning';
                debugLog('Monitoring gestartet');
                fetchBTCPrice();
            } else {
                btn.innerHTML = '▶️ Starten';
                btn.className = 'btn btn-success';
                debugLog('Monitoring pausiert');
            }
        });

        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                document.getElementById('modeDescription').textContent = 
                    `${btn.textContent} - ${getCurrentModeDescription()}`;
                debugLog(`Modus gewechselt zu: ${currentMode}`);
            });
        });

        function getCurrentModeDescription() {
            const descriptions = {
                bear: 'DCA & Accumulation Focus',
                bull: 'ATH & Fibonacci Targets',
                day: 'Live Updates & Volume',
                hodl: 'Langfristige Perspektive'
            };
            return descriptions[currentMode] || 'Unbekannter Modus';
        }

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').style.display = 'flex';
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    document.getElementById('installBanner').style.display = 'none';
                    debugLog('PWA erfolgreich installiert');
                }
                deferredPrompt = null;
            }
        });

        // Push Notifications (simplified)
        document.getElementById('pushBtn').addEventListener('click', () => {
            if (!('Notification' in window)) {
                alert('❌ Ihr Browser unterstützt keine Push-Benachrichtigungen.');
                return;
            }
            
            if (Notification.permission === 'granted') {
                pushEnabled = true;
                document.getElementById('pushBtn').innerHTML = '✅ Push aktiv';
                document.getElementById('pushBtn').className = 'btn btn-success';
                debugLog('Push-Benachrichtigungen aktiviert');
                
                // Test notification
                new Notification('🚀 BTC Monitor', {
                    body: 'Push-Benachrichtigungen sind jetzt aktiv!',
                    icon: '/favicon.ico'
                });
                return;
            }
            
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    pushEnabled = true;
                    document.getElementById('pushBtn').innerHTML = '✅ Push aktiv';
                    document.getElementById('pushBtn').className = 'btn btn-success';
                    debugLog('Push-Berechtigung erhalten');
                    
                    new Notification('🚀 BTC Monitor', {
                        body: 'Setup abgeschlossen - Push-Alerts sind aktiv!',
                        icon: '/favicon.ico'
                    });
                } else {
                    debugLog('Push-Berechtigung abgelehnt');
                    alert('❌ Push-Benachrichtigungen wurden abgelehnt.');
                }
            });
        });

        // Service Worker Registration
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'btc-monitor-cors-fix-v1.0';
                    const urlsToCache = ['/'];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                        self.clients.claim();
                    });

                    self.addEventListener('fetch', event => {
                        // Don't cache API requests
                        if (event.request.url.includes('api.') || 
                            event.request.url.includes('cors-anywhere') ||
                            event.request.method !== 'GET') {
                            event.respondWith(fetch(event.request));
                            return;
                        }
                        
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then(() => {
                    debugLog('Service Worker registriert');
                }).catch(error => {
                    debugLog(`Service Worker Fehler: ${error.message}`);
                });
            }
        }

        // Generate PWA Manifest
        function generateManifest() {
            const manifest = {
                "name": "BTC Live Trading Monitor",
                "short_name": "BTC Live",
                "description": "Live Bitcoin Trading Monitor mit CORS-Fix",
                "start_url": "/",
                "display": "standalone",
                "background_color": "#667eea",
                "theme_color": "#10b981",
                "icons": [
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxMGI5ODEiLz4KPHRleHQgeD0iOTYiIHk9IjEwNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjY0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+₿</text></svg>",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    }
                ]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestUrl;
            document.head.appendChild(link);
        }

        // Network status monitoring
        window.addEventListener('online', () => {
            debugLog('Internetverbindung wiederhergestellt');
            updateAPIStatus('loading', 'Verbindung wiederhergestellt - Lade Daten...');
            setTimeout(() => fetchBTCPrice(), 1000);
        });

        window.addEventListener('offline', () => {
            debugLog('Internetverbindung verloren');
            updateAPIStatus('offline', 'Keine Internetverbindung');
        });

        // Initialize
        async function init() {
            debugLog('=== BTC LIVE MONITOR CORS-FIX GESTARTET ===');
            debugLog(`Browser: ${navigator.userAgent.substring(0, 50)}...`);
            debugLog(`Online: ${navigator.onLine}`);
            debugLog(`Hostname: ${window.location.hostname}`);
            
            generateManifest();
            registerServiceWorker();
            updateFedCountdown();
            
            // Show debug panel initially if there are issues
            debugLog('Starte erste API-Abfrage...');
            
            // Try to fetch data
            const success = await fetchBTCPrice();
            if (!success) {
                // Show debug panel if APIs fail
                document.getElementById('debugPanel').style.display = 'block';
                debugMode = true;
                debugLog('⚠️ Alle APIs fehlgeschlagen - Debug-Panel aktiviert');
            } else {
                await fetchFearGreedIndex();
            }
            
            // Set up intervals
            setInterval(() => {
                updateFedCountdown();
            }, 1000);
            
            // Try to update every 60 seconds (less aggressive)
            setInterval(async () => {
                if (isMonitoring && apiOnline) {
                    debugLog('Automatisches Update...');
                    await fetchBTCPrice();
                }
            }, 60000);
            
            // Retry failed APIs every 5 minutes
            setInterval(async () => {
                if (!apiOnline && isMonitoring) {
                    debugLog('Retry-Versuch nach API-Ausfall...');
                    await fetchBTCPrice();
                }
            }, 300000);
            
            debugLog('=== INITIALISIERUNG ABGESCHLOSSEN ===');
        }

        // Error handling
        window.addEventListener('error', (event) => {
            debugLog(`JavaScript Fehler: ${event.error?.message || event.message}`);
            console.error('Global Error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            debugLog(`Promise Rejection: ${event.reason}`);
            console.error('Unhandled Promise Rejection:', event.reason);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case 'r':
                        event.preventDefault();
                        forceRetry();
                        break;
                    case 'd':
                        event.preventDefault();
                        document.getElementById('debugBtn').click();
                        break;
                    case ' ':
                        event.preventDefault();
                        document.getElementById('monitorBtn').click();
                        break;
                }
            }
        });

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Expose debug functions globally
        window.btcDebug = {
            forceRetry: forceRetry,
            currentPrice: () => currentPrice,
            priceData: () => priceData,
            apiStatus: () => apiOnline,
            logs: () => document.getElementById('debugLog').innerHTML
        };
    </script>
</body>
</html>
