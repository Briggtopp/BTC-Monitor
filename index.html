<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="BTC Monitor" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="BTC Monitor" />
  <meta name="theme-color" content="#10b981" />
  <meta name="msapplication-TileColor" content="#10b981" />

  <title>üöÄ BTC Trading Monitor</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 15px; color: #333;
    }
    .container { max-width: 1260px; margin: 0 auto; display: grid; gap: 20px; }
    .header {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      padding: 25px; border-radius: 20px; text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .price-display { font-size: 3rem; font-weight: bold; color: #10b981; margin: 15px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .countdown-container {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      padding: 25px; border-radius: 20px; text-align: center; margin: 20px 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .countdown-title { font-size: 1.3rem; color: #374151; margin-bottom: 15px; font-weight: 600; }
    .countdown-display { font-size: 2.5rem; font-weight: bold; color: #ef4444; margin: 10px 0; font-family: 'Courier New', monospace; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .countdown-details { font-size: 1rem; color: #6b7280; margin-top: 10px; }
    .volatility-info { background: #fef3c7; border: 1px solid #f59e0b; padding: 12px; border-radius: 10px; margin-top: 15px; font-size: 0.9rem; color: #92400e; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
    .card {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .card-title { font-size: 1.2rem; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }

    .phase-item { background: #f9fafb; border: 2px solid #e5e7eb; padding: 15px; border-radius: 10px; margin: 10px 0; transition: all 0.3s ease; }
    .phase-active { background: #d1fae5; border-color: #10b981; transform: scale(1.02); }
    .phase-title { font-weight: 600; font-size: 1rem; margin-bottom: 5px; }
    .phase-range { font-size: 0.85rem; color: #6b7280; margin-bottom: 8px; }
    .phase-status { font-size: 0.85rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; display: inline-block; }
    .status-active { background: #10b981; color: #fff; }
    .status-waiting { background: #f3f4f6; color: #6b7280; }

    .trigger-list { display: grid; gap: 8px; }
    .trigger-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 0.9rem; border: 1px solid transparent; transition: all 0.3s ease; }
    .trigger-active { background: #d1fae5; border-color: #10b981; color: #065f46; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #d1d5db; }
    .status-dot.active { background: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }

    .btn {
      background: #3b82f6; color: #fff; border: none; padding: 12px 20px; border-radius: 10px;
      font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; margin: 6px 6px; min-height: 44px; touch-action: manipulation;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59,130,246,0.4); }
    .btn-success { background: #10b981; }
    .btn-warning { background: #f59e0b; }
    .btn-danger { background: #ef4444; }
    .btn-outline { background: #fff; color: #374151; border: 1px solid #e5e7eb; }

    .button-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }

    .alert-box { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 0.9rem; }
    .success-box { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 0.9rem; }

    .kv { display: grid; grid-template-columns: 1fr auto; gap: 6px 10px; font-size: 0.9rem; }
    .small { font-size: 0.85rem; color: #6b7280; }
    .muted { color: #6b7280; }
    .mono { font-family: 'Courier New', monospace; }

    input, select {
      padding: 10px 12px; border-radius: 8px; border: 1px solid #e5e7eb;
      width: 100%; outline: none; font-size: 0.95rem; background: #fff;
    }
    .row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .mt8 { margin-top: 8px; } .mt12 { margin-top: 12px; } .mt16 { margin-top: 16px; } .mt20 { margin-top: 20px; }
    .ok { color: #10b981; } .warn { color: #f59e0b; } .bad { color: #ef4444; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 0.8rem; border:1px solid #e5e7eb; background:#fff; }

    .install-banner {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white; padding: 15px 20px; border-radius: 15px; margin-bottom: 20px;
      display: none; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .install-text { font-size: 1rem; font-weight: 500; }
    .install-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
    .install-btn:hover { background: rgba(255,255,255,0.3); }

    @media (max-width: 768px) {
      .price-display { font-size: 2.2rem; }
      .countdown-display { font-size: 1.8rem; }
      .grid { grid-template-columns: 1fr; }
      .container { padding: 10px; }
      .button-row { flex-direction: column; }
      .install-banner { flex-direction: column; text-align: center; gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
      <div class="install-text">üì± Als App installieren</div>
      <button class="install-btn" id="installBtn">Installieren</button>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>üöÄ BTC Trading Monitor</h1>
      <p>GitHub PWA ‚Äî Live BTC/USDT</p>
      <div class="price-display" id="btcPrice">$119,540</div>
      <div id="priceChange">+1.03% (24h)</div>

      <div class="button-row">
        <button class="btn btn-warning" id="pushBtn">üîî Push aktivieren</button>
        <button class="btn btn-success" id="refreshBtn">üîÑ Aktualisieren</button>
        <button class="btn" id="monitorBtn">‚è∏Ô∏è Pausieren</button>
      </div>
    </div>

    <!-- FOMC Countdown -->
    <div class="countdown-container">
      <div class="countdown-title">‚è∞ N√§chster FOMC Countdown</div>
      <div class="countdown-display" id="fomcCountdown">Wird geladen...</div>
      <div class="countdown-details" id="fomcDetail">Konfiguriert √ºber Fed‚ÄëTermine unten</div>
      <div class="volatility-info">
        ‚ö†Ô∏è An FOMC‚ÄëTagen ist erh√∂hte Volatilit√§t √ºblich. Crash‚ÄëDetection & Alerts helfen, schnelle Moves zu erfassen.
      </div>
    </div>

    <!-- Grid -->
    <div class="grid">
      <!-- Trading Phasen -->
      <div class="card">
        <div class="card-title">üí∞ Trading Phasen</div>
        <div class="phase-item" id="phase1">
          <div class="phase-title">Phase 1 (25%)</div>
          <div class="phase-range">$116,000 ‚Äì $119,000 | 140k USDT</div>
          <div class="phase-status status-waiting" id="phase1Status">Bereit</div>
        </div>
        <div class="phase-item" id="phase2">
          <div class="phase-title">Phase 2 (50%)</div>
          <div class="phase-range">$109,000 ‚Äì $114,000 | 280k USDT</div>
          <div class="phase-status status-waiting" id="phase2Status">Wartend</div>
        </div>
        <div class="phase-item" id="phase3">
          <div class="phase-title">Phase 3 (25%)</div>
          <div class="phase-range">$103,000 ‚Äì $108,000 | 140k USDT</div>
          <div class="phase-status status-waiting" id="phase3Status">Reserve</div>
        </div>
      </div>

      <!-- Trigger Status -->
      <div class="card">
        <div class="card-title">üìä Trigger Status</div>
        <div class="trigger-list">
          <div class="trigger-item" id="trigger1"><span>1h Close > $118,400</span><div class="status-dot" id="dot1"></div></div>
          <div class="trigger-item" id="trigger2"><span>Spot ‚â• $119,100</span><div class="status-dot" id="dot2"></div></div>
          <div class="trigger-item" id="trigger3"><span>Spot ‚â§ $117,200</span><div class="status-dot" id="dot3"></div></div>
          <div class="trigger-item" id="trigger4"><span>Zone $116.4k‚Äì$116.9k</span><div class="status-dot" id="dot4"></div></div>
          <div class="trigger-item" id="trigger5"><span>Spot ‚â§ $116,100</span><div class="status-dot" id="dot5"></div></div>
          <div class="trigger-item" id="trigger6"><span>Spot ‚â§ $114,500</span><div class="status-dot" id="dot6"></div></div>
        </div>
        <div class="mt12 small">
          Letzter 1h Close: <strong id="lastClose">$118,062</strong>
        </div>
      </div>

      <!-- PCE Countdown -->
      <div class="card">
        <div class="card-title">üìä PCE Data Countdown</div>
        <div style="text-align:center; padding: 20px;">
          <div style="font-size:1.8rem; font-weight:bold; color:#f59e0b;" id="pceCountdown">Wird geladen‚Ä¶</div>
          <div class="small">31. Juli 2025, 12:30 UTC</div>
          <div class="small ok mt8">Hinweis: Makrodaten k√∂nnen starke Bewegungen ausl√∂sen.</div>
        </div>
      </div>

      <!-- Fear & Greed -->
      <div class="card">
        <div class="card-title">üò± Fear & Greed Index</div>
        <div class="kv">
          <div>Aktueller Wert</div><div class="mono" id="fearGreedValue">‚Äì</div>
          <div>Interpretation</div><div id="fearGreedText" class="mono">‚Äì</div>
          <div>Letztes Update</div><div id="fearGreedTime" class="mono">‚Äì</div>
        </div>
        <div class="meter-bar mt12"><div class="meter-indicator" id="fearGreedIndicator" style="left:50%"></div></div>
        <div class="small muted mt8" id="fearGreedNote">Versuch Live‚ÄëAbruf (alternative.me). Fallback bei CORS.</div>
      </div>

      <!-- Fed-Termine -->
      <div class="card">
        <div class="card-title">üóìÔ∏è N√§chste Fed‚ÄëTermine</div>
        <div class="row">
          <div>
            <label class="small muted">Neuer Termin (UTC, ISO 8601)</label>
            <input id="fedInput" placeholder="2025-07-30T14:00:00Z" />
          </div>
          <div>
            <label class="small muted">Bezeichnung</label>
            <input id="fedLabel" placeholder="FOMC Meeting" />
          </div>
        </div>
        <div class="mt8">
          <button class="btn btn-outline" id="fedAddBtn">‚ûï Termin hinzuf√ºgen</button>
          <button class="btn btn-outline" id="fedClearBtn">üóëÔ∏è Alle l√∂schen</button>
        </div>
        <div class="mt12 small muted">Gespeichert in LocalStorage. Der n√§chste Termin steuert den gro√üen Countdown oben.</div>
        <div class="mt12">
          <div class="small muted">Termine:</div>
          <ul id="fedList" class="mt8" style="list-style: none; padding-left: 0;"></ul>
        </div>
      </div>

      <!-- Crash Detection -->
      <div class="card">
        <div class="card-title">üßØ Crash‚ÄëDetection</div>
        <div class="row3">
          <div><label class="small muted">1‚ÄØmin Schwelle (%)</label><input id="thr1" type="number" value="-1.0" /></div>
          <div><label class="small muted">5‚ÄØmin Schwelle (%)</label><input id="thr5" type="number" value="-3.0" /></div>
          <div><label class="small muted">15‚ÄØmin Schwelle (%)</label><input id="thr15" type="number" value="-5.0" /></div>
        </div>
        <div class="mt8">
          <button class="btn btn-success" id="crashToggle">‚úÖ Aktiv</button>
          <span class="small muted" id="crashStatus">√úberwacht Preis√§nderungen und sendet Push.</span>
        </div>
        <div class="mt12">
          <div class="small muted">Letzte Signale:</div>
          <ul id="crashLog" style="list-style:none; padding-left:0; max-height:160px; overflow:auto;"></ul>
        </div>
      </div>

      <!-- Bear Market Survival -->
      <div class="card">
        <div class="card-title">üêª Bear Market Survival</div>
        <!-- DCA -->
        <div class="small muted">DCA‚ÄëRechner (holt 1D‚ÄëKlines; Close‚ÄëPreis je Intervall)</div>
        <div class="row3 mt8">
          <div>
            <label class="small muted">Zeitraum (Tage)</label>
            <input id="dcaDays" type="number" min="30" max="1000" value="365" />
          </div>
          <div>
            <label class="small muted">Intervall</label>
            <select id="dcaInterval">
              <option value="daily">t√§glich</option>
              <option value="weekly">w√∂chentlich</option>
              <option value="monthly">monatlich</option>
            </select>
          </div>
          <div>
            <label class="small muted">Betrag je Kauf (USDT)</label>
            <input id="dcaAmount" type="number" min="1" value="100" />
          </div>
        </div>
        <button class="btn mt8" id="dcaCalcBtn">üßÆ DCA berechnen</button>
        <div class="kv mt12" id="dcaOut">
          <div>Investiert</div><div class="mono" id="dcaInvested">‚Äì</div>
          <div>BTC erworben</div><div class="mono" id="dcaCoins">‚Äì</div>
          <div>√ò‚ÄëPreis</div><div class="mono" id="dcaAvg">‚Äì</div>
          <div>Wert @ Spot</div><div class="mono" id="dcaValue">‚Äì</div>
          <div>P/L</div><div class="mono" id="dcaPL">‚Äì</div>
        </div>

        <!-- Accumulation Zonen -->
        <div class="mt20 small muted">Accumulation‚ÄëZonen (200D‚ÄëSMA)</div>
        <div class="kv mt8">
          <div>200D‚ÄëSMA</div><div class="mono" id="sma200">‚Äì</div>
          <div>Zone A (‚â§80% SMA)</div><div class="mono" id="zoneA">‚Äì</div>
          <div>Zone B (80‚Äì90% SMA)</div><div class="mono" id="zoneB">‚Äì</div>
          <div>Zone C (90‚Äì100% SMA)</div><div class="mono" id="zoneC">‚Äì</div>
          <div>Status @ Spot</div><div class="mono" id="zoneStatus">‚Äì</div>
        </div>
      </div>

      <!-- Bull Run Tracker -->
      <div class="card">
        <div class="card-title">üêÇ Bull Run Tracker</div>
        <div class="kv">
          <div>ATH (High)</div><div class="mono" id="athPrice">‚Äì</div>
          <div>ATH Datum</div><div class="mono" id="athDate">‚Äì</div>
          <div>Distanz zu ATH</div><div class="mono" id="athDist">‚Äì</div>
          <div>Tage seit ATH</div><div class="mono" id="athDays">‚Äì</div>
        </div>
        <div class="mt12 small muted">Fibonacci‚ÄëLevels (Cycle Low ‚Üî ATH)</div>
        <div class="kv mt8" id="fibList"></div>

        <div class="mt16 small muted">Profit‚ÄëTaking Zonen</div>
        <div class="row3 mt8">
          <div><label class="small muted">Einstieg (USDT)</label><input id="entryPrice" type="number" value="100000" /></div>
          <div><label class="small muted">Staffel (%)</label><input id="ptSteps" type="text" value="10,20,30" /></div>
          <div><label class="small muted">Menge (BTC)</label><input id="ptSize" type="number" value="0.5" /></div>
        </div>
        <button class="btn mt8" id="ptCalcBtn">üéØ Zonen berechnen</button>
        <ul id="ptList" class="mt8" style="list-style:none; padding-left:0;"></ul>
      </div>

      <!-- Day Trading Mode -->
      <div class="card">
        <div class="card-title">üü¢ Day Trading Mode</div>
        <div class="row">
          <div><button class="btn btn-success" id="dayToggle">‚úÖ Aktiv</button></div>
          <div><span class="small muted" id="dayStatus">5m/15m EMA9/EMA21‚ÄëCross + RSI(14) + Volume‚ÄëSpikes</span></div>
        </div>
        <div class="row3 mt12">
          <div class="pill">Letztes 5m‚ÄëSignal: <span id="sig5m" class="mono">‚Äì</span></div>
          <div class="pill">Letztes 15m‚ÄëSignal: <span id="sig15m" class="mono">‚Äì</span></div>
          <div class="pill">Letzter Volume‚ÄëSpike: <span id="sigVol" class="mono">‚Äì</span></div>
        </div>
        <div class="mt12 small muted">Support/Resistance (5m, letzte ~100 Kerzen)</div>
        <div class="kv mt8">
          <div>Support</div><div class="mono" id="srSupport">‚Äì</div>
          <div>Resistance</div><div class="mono" id="srResistance">‚Äì</div>
        </div>
        <div class="mt12">
          <div class="small muted">Signallog:</div>
          <ul id="dayLog" style="list-style:none; padding-left:0; max-height:180px; overflow:auto;"></ul>
        </div>
      </div>

      <!-- Empfehlungen -->
      <div class="card">
        <div class="card-title">üéØ Trading Empfehlungen</div>
        <div class="alert-box">
          <strong>Hinweis:</strong><br/>
          Nutze Crash‚ÄëDetection und Day‚ÄëTrading‚ÄëSignale f√ºr Intraday‚ÄëRisikomanagement. Nutze DCA & Zonen f√ºr langfristige Allokation.
        </div>
        <div class="success-box" id="currentRecommendation">
          <strong>üìç Status</strong><br/>
          Wartet auf Signale.
        </div>
      </div>

      <!-- App Info -->
      <div class="card">
        <div class="card-title">‚ÑπÔ∏è App Info</div>
        <div class="small">
          <p><strong>GitHub PWA Version 2.3</strong></p>
          <p>üì° Live‚ÄëUpdates: Echtzeit (WS) + Fallback 5‚ÄØs</p>
          <p>üîî Push‚ÄëBenachrichtigungen</p>
          <p>üì± Installation: Alle Browser</p>
          <p>‚ö° Offline‚Äëf√§hig</p>
          <p>üéØ Letztes Update: <span id="lastUpdate">‚Äì</span></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Globale Variablen =========
    let currentPrice = 119540;
    let lastHourClose = 118062;
    let pushEnabled = false;
    let isMonitoring = true;
    let deferredPrompt;
    let updateCounter = 0;
    let fearGreedIndex = 50;

    // FOMC & PCE
    let FOMC_NEXT = null; // aus Fed‚ÄëTerminen
    const PCE_DATE = new Date('2025-07-31T12:30:00Z');

    // Preisverlauf (Crash‚ÄëDetection)
    const priceHistory = []; // [{t: ms, p: price}]
    const PRICE_HISTORY_WINDOW_MS = 60 * 60 * 1000; // 60m

    // Day‚ÄëTrading
    let dayModeOn = true;
    let crashOn = true;

    // ========= PWA Install =========
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBanner').style.display = 'flex';
    });
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('installBanner').style.display = 'none';
      if (pushEnabled) sendNotification('App installiert!', 'BTC Monitor installiert.');
    });

    // ========= Countdowns =========
    function fmt2(n){return n<10?'0'+n:n;}
    function updateCountdowns() {
      const now = new Date();

      // FOMC
      if (FOMC_NEXT) {
        const diff = FOMC_NEXT - now;
        if (diff > 0) {
          const d = Math.floor(diff/86400000);
          const h = Math.floor((diff%86400000)/3600000);
          const m = Math.floor((diff%3600000)/60000);
          const s = Math.floor((diff%60000)/1000);
          document.getElementById('fomcCountdown').textContent = `${d>0?d+'d ':''}${fmt2(h)}h ${fmt2(m)}m ${fmt2(s)}s`;
          document.getElementById('fomcDetail').textContent = `${FOMC_NEXT.toISOString()} UTC`;
          if (diff < 24*3600000) document.getElementById('fomcCountdown').style.color = '#dc2626';
        } else {
          document.getElementById('fomcCountdown').textContent = 'FOMC LIVE!';
          document.getElementById('fomcCountdown').style.color = '#dc2626';
        }
      } else {
        document.getElementById('fomcCountdown').textContent = 'Termin fehlt';
        document.getElementById('fomcDetail').textContent = 'F√ºge unten einen FOMC‚ÄëTermin hinzu.';
      }

      // PCE
      const pceDiff = PCE_DATE - now;
      if (pceDiff > 0) {
        const d = Math.floor(pceDiff/86400000);
        const h = Math.floor((pceDiff%86400000)/3600000);
        const m = Math.floor((pceDiff%3600000)/60000);
        document.getElementById('pceCountdown').textContent = `PCE in ${d>0?d+'d ':''}${fmt2(h)}h ${fmt2(m)}m`;
      } else {
        document.getElementById('pceCountdown').textContent = 'PCE ver√∂ffentlicht';
      }
    }
    function updateLastUpdateTime() {
      const ts = new Date();
      const hh = fmt2(ts.getHours()), mm = fmt2(ts.getMinutes()), ss = fmt2(ts.getSeconds());
      document.getElementById('lastUpdate').textContent = `${hh}:${mm}:${ss}`;
    }

    // ========= Binance Live‚ÄëPreis (Ticker + 5m/15m Klines) =========
    const STREAM_URL = 'wss://stream.binance.com:9443/stream?streams=btcusdt@ticker|btcusdt@kline_5m|btcusdt@kline_15m';
    let ws = null, pollTimer = null;

    function applyPriceUpdate(priceFloat, changePctFloat) {
      currentPrice = Math.round(priceFloat);

      document.getElementById('btcPrice').textContent = `$${currentPrice.toLocaleString('en-US')}`;

      const changeEl = document.getElementById('priceChange');
      const sign = changePctFloat >= 0 ? '+' : '';
      changeEl.textContent = `${sign}${changePctFloat.toFixed(2)}% (24h)`;
      changeEl.style.color = changePctFloat >= 0 ? '#10b981' : '#ef4444';

      // Historie f√ºr Crash‚ÄëDetection
      const now = Date.now();
      priceHistory.push({ t: now, p: currentPrice });
      while (priceHistory.length && (now - priceHistory[0].t) > PRICE_HISTORY_WINDOW_MS) priceHistory.shift();
      if (crashOn) checkCrashSignals();

      updatePhases();
      updateTriggers();
      generateRecommendations();
      updateFearGreedUI();
      updateLastUpdateTime();
    }

    function startPriceStream() {
      try {
        ws = new WebSocket(STREAM_URL);
        ws.onmessage = (evt) => {
          const obj = JSON.parse(evt.data);
          const stream = obj.stream;
          const d = obj.data;
          if (stream.endsWith('@ticker')) {
            const last = parseFloat(d.c);
            const pct  = parseFloat(d.P);
            if (Number.isFinite(last) && Number.isFinite(pct)) applyPriceUpdate(last, pct);
          } else if (stream.includes('@kline_5m')) {
            onKline('5m', d.k);
          } else if (stream.includes('@kline_15m')) {
            onKline('15m', d.k);
          }
        };
        ws.onclose = () => startPricePollingFallback();
        ws.onerror = () => { try{ws.close();}catch{} };
      } catch {
        startPricePollingFallback();
      }
    }

    async function pollOnce() {
      try {
        const r = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT', { cache: 'no-store' });
        const j = await r.json();
        const last = parseFloat(j.lastPrice);
        const pct  = parseFloat(j.priceChangePercent);
        if (Number.isFinite(last) && Number.isFinite(pct)) applyPriceUpdate(last, pct);
      } catch {}
    }
    function startPricePollingFallback() {
      if (pollTimer) clearInterval(pollTimer);
      pollOnce();
      pollTimer = setInterval(pollOnce, 5000);
    }

    async function fetchLastHourClose() {
      try {
        const r = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&limit=2', { cache: 'no-store' });
        const a = await r.json();
        if (Array.isArray(a) && a.length >= 1) {
          const prevClose = parseFloat(a[0][4]);
          if (Number.isFinite(prevClose)) {
            lastHourClose = Math.round(prevClose);
            document.getElementById('lastClose').textContent = `$${lastHourClose.toLocaleString('en-US')}`;
            updateTriggers();
          }
        }
      } catch {}
    }

    // ========= Phasen / Trigger =========
    function updatePhases() {
      const p1 = currentPrice >= 116000 && currentPrice <= 119000;
      updatePhase('phase1', 'phase1Status', p1, 'üéØ AKTIV', 'Bereit');
      const p2 = currentPrice >= 109000 && currentPrice <= 114000;
      updatePhase('phase2', 'phase2Status', p2, 'üöÄ EXECUTE!', 'Wartend');
      const p3 = currentPrice >= 103000 && currentPrice <= 108000;
      updatePhase('phase3', 'phase3Status', p3, 'üíé DEEP VALUE!', 'Reserve');
    }
    function updatePhase(id, sid, active, aTxt, iTxt) {
      const el = document.getElementById(id), st = document.getElementById(sid);
      if (active) { el.classList.add('phase-active'); st.textContent = aTxt; st.className = 'phase-status status-active'; }
      else { el.classList.remove('phase-active'); st.textContent = iTxt; st.className = 'phase-status status-waiting'; }
    }
    function updateTriggers() {
      setTrigger('trigger1','dot1', lastHourClose > 118400);
      setTrigger('trigger2','dot2', currentPrice >= 119100);
      setTrigger('trigger3','dot3', currentPrice <= 117200);
      setTrigger('trigger4','dot4', currentPrice >= 116400 && currentPrice <= 116900);
      setTrigger('trigger5','dot5', currentPrice <= 116100);
      setTrigger('trigger6','dot6', currentPrice <= 114500);
    }
    function setTrigger(tid, did, on) {
      const t = document.getElementById(tid), d = document.getElementById(did);
      if (on) { t.classList.add('trigger-active'); d.classList.add('active'); }
      else { t.classList.remove('trigger-active'); d.classList.remove('active'); }
    }

    function generateRecommendations() {
      const rec = document.getElementById('currentRecommendation');
      if (currentPrice >= 119000 && currentPrice <= 121000) {
        rec.innerHTML = '<strong>‚ö†Ô∏è Short‚ÄëLiquidit√§tscluster</strong><br>$'+currentPrice.toLocaleString()+' ‚Äì Stop‚ÄëHunt m√∂glich.';
      } else if (currentPrice < 116000 && currentPrice >= 109000) {
        rec.innerHTML = '<strong>üéØ Phase 2 Bereich</strong><br>$'+currentPrice.toLocaleString()+' ‚Äì Staffelk√§ufe vorbereiten.';
      } else if (currentPrice < 109000) {
        rec.innerHTML = '<strong>üíé Deep Value</strong><br>$'+currentPrice.toLocaleString()+' ‚Äì Reserve pr√ºfen.';
      } else {
        rec.innerHTML = '<strong>üìç Normaler Handel</strong><br>$'+currentPrice.toLocaleString()+' ‚Äì Setup abwarten.';
      }
    }

    // ========= Fear & Greed =========
    async function fetchFearGreed() {
      try {
        const r = await fetch('https://api.alternative.me/fng/?limit=1&format=json', { cache: 'no-store' });
        const j = await r.json();
        if (j && j.data && j.data[0]) {
          fearGreedIndex = parseInt(j.data[0].value, 10);
          const ts = parseInt(j.data[0].timestamp, 10) * 1000;
          document.getElementById('fearGreedTime').textContent = new Date(ts).toISOString();
          updateFearGreedUI();
          document.getElementById('fearGreedNote').textContent = 'Live‚ÄëAbruf erfolgreich.';
        }
      } catch {
        document.getElementById('fearGreedNote').textContent = 'Live‚ÄëAbruf blockiert ‚Äì Fallback aktiv.';
        updateFearGreedUI();
      }
    }
    function updateFearGreedUI() {
      const v = Math.max(0, Math.min(100, Math.round(fearGreedIndex)));
      document.getElementById('fearGreedValue').textContent = v;
      document.getElementById('fearGreedIndicator').style.left = v + '%';
      const text = v < 25 ? 'Extreme Fear' : v < 45 ? 'Fear' : v < 55 ? 'Neutral' : v < 75 ? 'Greed' : 'Extreme Greed';
      document.getElementById('fearGreedText').textContent = text;
    }

    // ========= Fed‚ÄëTermine (LocalStorage) =========
    const FED_KEY = 'fed_events_v1';
    function loadFedEvents() {
      try { return JSON.parse(localStorage.getItem(FED_KEY) || '[]'); } catch { return []; }
    }
    function saveFedEvents(list) { localStorage.setItem(FED_KEY, JSON.stringify(list)); }
    function renderFedEvents() {
      const ul = document.getElementById('fedList'); ul.innerHTML = '';
      const list = loadFedEvents().sort((a,b)=>new Date(a.ts)-new Date(b.ts));
      list.forEach((e, idx) => {
        const li = document.createElement('li');
        li.className = 'mt8';
        li.innerHTML = `<span class="mono">${e.ts}</span> ‚Äî ${e.label} <button class="btn btn-outline small" data-i="${idx}">Entfernen</button>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', ()=>{
          const i = parseInt(btn.getAttribute('data-i'),10);
          const cur = loadFedEvents(); cur.splice(i,1); saveFedEvents(cur); renderFedEvents(); selectNextFOMC();
        });
      });
      selectNextFOMC();
    }
    function selectNextFOMC() {
      const now = new Date();
      const upcoming = loadFedEvents().map(e => ({...e, d:new Date(e.ts)})).filter(e => e.d > now).sort((a,b)=>a.d-b.d);
      FOMC_NEXT = upcoming.length ? upcoming[0].d : null;
      updateCountdowns();
    }
    function addFedEvent(tsISO, label) {
      if (!tsISO) return;
      const d = new Date(tsISO);
      if (isNaN(d.getTime())) { alert('Ung√ºltiges ISO‚ÄëDatum.'); return; }
      const list = loadFedEvents(); list.push({ ts: tsISO, label: label || 'FOMC' }); saveFedEvents(list); renderFedEvents();
    }

    // ========= Crash‚ÄëDetection =========
    function pctChange(a,b){ return ((b-a)/a)*100; }
    function findPriceAt(msAgo) {
      const target = Date.now() - msAgo;
      for (let i=priceHistory.length-1; i>=0; i--) {
        if (priceHistory[i].t <= target) return priceHistory[i].p;
      }
      return null;
    }
    function logCrash(msg, cls='bad') {
      const li = document.createElement('li');
      li.className = 'mt8 ' + cls;
      li.textContent = msg;
      const ul = document.getElementById('crashLog'); ul.prepend(li);
      while (ul.children.length > 30) ul.removeChild(ul.lastChild);
      if (pushEnabled) sendNotification('Preis‚ÄëAlarm', msg);
    }
    function checkCrashSignals() {
      const t1 = parseFloat(document.getElementById('thr1').value || '-1');
      const t5 = parseFloat(document.getElementById('thr5').value || '-3');
      const t15 = parseFloat(document.getElementById('thr15').value || '-5');
      const pNow = currentPrice;

      const p1 = findPriceAt(60*1000);
      if (p1) {
        const pc1 = pctChange(p1, pNow);
        if (pc1 <= t1) logCrash(`‚àí${Math.abs(pc1).toFixed(2)}% in 1m ‚Üí $${pNow.toLocaleString()}`, 'bad');
        if (pc1 >= Math.abs(t1)) logCrash(`+${pc1.toFixed(2)}% in 1m ‚Üí $${pNow.toLocaleString()}`, 'ok');
      }
      const p5 = findPriceAt(5*60*1000);
      if (p5) {
        const pc5 = pctChange(p5, pNow);
        if (pc5 <= t5) logCrash(`‚àí${Math.abs(pc5).toFixed(2)}% in 5m ‚Üí $${pNow.toLocaleString()}`, 'bad');
        if (pc5 >= Math.abs(t5)) logCrash(`+${pc5.toFixed(2)}% in 5m ‚Üí $${pNow.toLocaleString()}`, 'ok');
      }
      const p15 = findPriceAt(15*60*1000);
      if (p15) {
        const pc15 = pctChange(p15, pNow);
        if (pc15 <= t15) logCrash(`‚àí${Math.abs(pc15).toFixed(2)}% in 15m ‚Üí $${pNow.toLocaleString()}`, 'bad');
        if (pc15 >= Math.abs(t15)) logCrash(`+${pc15.toFixed(2)}% in 15m ‚Üí $${pNow.toLocaleString()}`, 'ok');
      }
    }

    // ========= Day‚ÄëTrading‚ÄëSignale =========
    const buf5m = []; // {open, high, low, close, volume, t, closed}
    const buf15m = [];
    function onKline(tf, k) {
      const obj = { open:+k.o, high:+k.h, low:+k.l, close:+k.c, volume:+k.v, closed:k.x, t:k.t };
      const buf = tf==='5m' ? buf5m : buf15m;
      if (buf.length && buf[buf.length-1].t === obj.t) buf[buf.length-1] = obj;
      else buf.push(obj);
      const maxLen = 200; while (buf.length>maxLen) buf.shift();

      if (dayModeOn) {
        const sig = computeSignals(buf);
        if (sig && obj.closed) {
          const msg = `${tf} ${sig.type} @ ${obj.close.toFixed(0)} (RSI ${sig.rsi.toFixed(0)}, EMA9/21 ${sig.ema9.toFixed(0)}/${sig.ema21.toFixed(0)})`;
          logDay(msg, sig.type==='BUY'?'ok':'bad');
        }
        const volMsg = volumeSpike(buf);
        if (volMsg && obj.closed) logDay(`${tf} ${volMsg}`, 'warn', true);
        updateSR();
      }
    }
    function ema(arr, period, accessor) {
      const k = 2/(period+1);
      let emaVal = accessor(arr[0]); for (let i=1;i<arr.length;i++) emaVal = accessor(arr[i])*k + emaVal*(1-k);
      return emaVal;
    }
    function rsi(arr, period=14) {
      if (arr.length<period+1) return 50;
      let gains=0, losses=0;
      for (let i=arr.length-period;i<arr.length;i++){
        const ch = arr[i].close - arr[i-1].close;
        if (ch>0) gains += ch; else losses -= ch;
      }
      const avgG = gains/period, avgL = (losses/period)||1e-9;
      const rs = avgG/avgL;
      return 100 - (100/(1+rs));
    }
    function computeSignals(buf) {
      if (buf.length<21) return null;
      const ema9  = ema(buf.slice(-50),  9, x=>x.close);
      const ema21 = ema(buf.slice(-50), 21, x=>x.close);
      const r = rsi(buf, 14);
      let type = null;
      if (ema9>ema21 && r>55) type = 'BUY';
      if (ema9<ema21 && r<45) type = 'SELL';
      if (!type) return null;
      return { type, rsi:r, ema9, ema21 };
    }
    function volumeSpike(buf) {
      if (buf.length<25) return null;
      const last = buf[buf.length-1];
      const avg = buf.slice(-21,-1).reduce((s,b)=>s+b.volume,0)/20;
      if (avg>0 && last.volume>1.5*avg) {
        document.getElementById('sigVol').textContent = `${(last.volume).toFixed(2)} (>1.5√ó)`;
        if (pushEnabled) sendNotification('Volume Spike', `Vol > 1.5√ó (TF aktuell)`);
        return `Volume‚ÄëSpike: ${(last.volume).toFixed(2)} (>1.5√ó 20‚ÄëSchnitt)`;
      }
      return null;
    }
    function logDay(msg, cls='ok', noPush=false) {
      const ul = document.getElementById('dayLog');
      const li = document.createElement('li'); li.className = 'mt8 '+cls; li.textContent = msg; ul.prepend(li);
      while (ul.children.length>50) ul.removeChild(ul.lastChild);
      if (!noPush && pushEnabled) sendNotification('Day‚ÄëTrading', msg);
      if (msg.startsWith('5m')) document.getElementById('sig5m').textContent = msg;
      if (msg.startsWith('15m')) document.getElementById('sig15m').textContent = msg;
    }
    function updateSR() {
      if (buf5m.length<50) return;
      const highs = buf5m.slice(-100).map(b=>b.high);
      const lows  = buf5m.slice(-100).map(b=>b.low);
      const res = Math.max(...highs);
      const sup = Math.min(...lows);
      document.getElementById('srResistance').textContent = `$${Math.round(res).toLocaleString('en-US')}`;
      document.getElementById('srSupport').textContent = `$${Math.round(sup).toLocaleString('en-US')}`;
    }

    // ========= DCA / SMA200 / ATH & Fibs =========
    async function fetchDaily(limit=365) {
      const lim = Math.max(30, Math.min(1000, limit));
      const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=${lim}`;
      const r = await fetch(url, { cache: 'no-store' });
      const a = await r.json();
      return a.map(x=>({ open:+x[1], high:+x[2], low:+x[3], close:+x[4], vol:+x[5], t:+x[0] }));
    }
    function fmtUSD(n){ return '$'+Math.round(n).toLocaleString('en-US'); }
    function dcaSim(kl, interval, amount) {
      const buys = [];
      if (interval==='daily') for (let i=0;i<kl.length;i++) buys.push(kl[i]);
      else if (interval==='weekly') for (let i=0;i<kl.length;i+=7) buys.push(kl[i]);
      else { let lastMonth=-1; for (let i=0;i<kl.length;i++){ const m=new Date(kl[i].t).getUTCMonth(); if(m!==lastMonth){ buys.push(kl[i]); lastMonth=m; } } }
      let invested=0, coins=0;
      buys.forEach(b => { invested += amount; coins += amount / b.close; });
      const avg = invested / (coins || 1e-9);
      return { invested, coins, avg };
    }
    function sma(arr, period) {
      if (arr.length<period) return null;
      let sum = 0; for (let i=arr.length-period;i<arr.length;i++) sum += arr[i].close;
      return sum/period;
    }
    function fibs(fromLow, toHigh) {
      const diff = toHigh - fromLow;
      return [
        {label:'23.6%', val: toHigh - 0.236*diff},
        {label:'38.2%', val: toHigh - 0.382*diff},
        {label:'50.0%', val: toHigh - 0.5*diff},
        {label:'61.8%', val: toHigh - 0.618*diff},
        {label:'78.6%', val: toHigh - 0.786*diff},
      ];
    }

    async function runDCA() {
      try {
        const days = parseInt(document.getElementById('dcaDays').value,10);
        const interval = document.getElementById('dcaInterval').value;
        const amount = parseFloat(document.getElementById('dcaAmount').value);
        const kl = await fetchDaily(days);
        const res = dcaSim(kl, interval, amount);
        document.getElementById('dcaInvested').textContent = fmtUSD(res.invested);
        document.getElementById('dcaCoins').textContent = res.coins.toFixed(6)+' BTC';
        document.getElementById('dcaAvg').textContent = fmtUSD(res.avg);
        const value = res.coins * currentPrice;
        document.getElementById('dcaValue').textContent = fmtUSD(value);
        const pl = value - res.invested;
        const sign = pl>=0?'+':'';
        document.getElementById('dcaPL').textContent = `${sign}${fmtUSD(pl)}`;
      } catch { alert('DCA‚ÄëBerechnung fehlgeschlagen.'); }
    }

    async function updateSMAZonesAndATH() {
      try {
        const kl = await fetchDaily(1000);
        // SMA200
        const vSMA = sma(kl, 200);
        if (vSMA) {
          document.getElementById('sma200').textContent = fmtUSD(vSMA);
          const zA = 0.8*vSMA, zB1 = 0.8*vSMA, zB2 = 0.9*vSMA, zC1 = 0.9*vSMA, zC2 = 1.0*vSMA;
          document.getElementById('zoneA').textContent = '‚â§ ' + fmtUSD(zA);
          document.getElementById('zoneB').textContent = fmtUSD(zB1) + ' ‚Äì ' + fmtUSD(zB2);
          document.getElementById('zoneC').textContent = fmtUSD(zC1) + ' ‚Äì ' + fmtUSD(zC2);
          let status = '√úber SMA';
          if (currentPrice <= zA) status = 'Zone A';
          else if (currentPrice <= zB2) status = 'Zone B';
          else if (currentPrice <= zC2) status = 'Zone C';
          document.getElementById('zoneStatus').textContent = status;
        } else {
          document.getElementById('sma200').textContent = '‚Äì';
          document.getElementById('zoneStatus').textContent = 'nicht genug Daten';
        }
        // ATH & Fibs
        let ath = { price: -Infinity, t: null };
        let cycleLow = { price: Infinity, t: null };
        for (const c of kl) {
          if (c.high > ath.price) ath = { price: c.high, t: c.t };
          if (c.low < cycleLow.price) cycleLow = { price: c.low, t: c.t };
        }
        document.getElementById('athPrice').textContent = fmtUSD(ath.price);
        document.getElementById('athDate').textContent = new Date(ath.t).toISOString().slice(0,10);
        const dist = ((ath.price - currentPrice)/ath.price)*100;
        document.getElementById('athDist').textContent = (dist>=0?dist.toFixed(2)+'% unter ATH':(-dist).toFixed(2)+'% √ºber ATH');
        const daysSince = Math.floor((Date.now()-ath.t)/86400000);
        document.getElementById('athDays').textContent = daysSince + ' Tage';
        const levels = fibs(cycleLow.price, ath.price);
        const fibWrap = document.getElementById('fibList'); fibWrap.innerHTML = '';
        levels.forEach(l=>{
          const k = document.createElement('div'); k.textContent = l.label; fibWrap.appendChild(k);
          const v = document.createElement('div'); v.className='mono'; v.textContent = fmtUSD(l.val); fibWrap.appendChild(v);
        });
      } catch {}
    }

    // ========= Profit‚ÄëTaking =========
    function calcPT() {
      const entry = parseFloat(document.getElementById('entryPrice').value||'0');
      const steps = (document.getElementById('ptSteps').value||'10,20,30').split(',').map(s=>parseFloat(s.trim())).filter(x=>!isNaN(x));
      const size = parseFloat(document.getElementById('ptSize').value||'0');
      const ul = document.getElementById('ptList'); ul.innerHTML = '';
      steps.forEach(p=>{
        const lvl = entry * (1 + p/100);
        const li = document.createElement('li'); li.className = 'mt8';
        const diff = ((currentPrice - lvl)/lvl)*100;
        li.textContent = `${p}% ‚Üí ${fmtUSD(lvl)} (${diff>=0?'+':''}${diff.toFixed(2)}% vs Spot) ‚Äî Teilverkauf: ${(size*0.3333).toFixed(4)} BTC`;
        ul.appendChild(li);
      });
    }

    // ========= Push =========
    function enablePush() {
      if (!('Notification' in window)) { alert('Browser unterst√ºtzt keine Push‚ÄëBenachrichtigungen.'); return; }
      if (Notification.permission === 'granted') { pushEnabled = true; updatePushButton(); sendNotification('BTC Monitor', 'Push aktiv.'); return; }
      Notification.requestPermission().then(p => {
        if (p === 'granted') { pushEnabled = true; updatePushButton(); sendNotification('BTC Monitor', 'Push aktiv.'); }
        else alert('Push abgelehnt.');
      });
    }
    function updatePushButton() {
      const btn = document.getElementById('pushBtn');
      if (pushEnabled) { btn.innerHTML = '‚úÖ Push aktiv'; btn.className = 'btn btn-success'; }
    }
    function sendNotification(title, body) {
      if (!pushEnabled || Notification.permission!=='granted') return;
      try {
        const n = new Notification(`üö® ${title}`, { body, icon:'/favicon.ico', tag:'btc-monitor', requireInteraction:false, vibrate:[200,100,200] });
        setTimeout(()=>n.close(), 8000);
      } catch {}
    }

    // ========= Controls =========
    function toggleMonitoring() {
      isMonitoring = !isMonitoring;
      const btn = document.getElementById('monitorBtn');
      if (isMonitoring) { btn.innerHTML = '‚è∏Ô∏è Pausieren'; btn.className = 'btn btn-warning'; }
      else { btn.innerHTML = '‚ñ∂Ô∏è Starten'; btn.className = 'btn btn-success'; }
      if (pushEnabled) sendNotification('Monitor', isMonitoring?'gestartet':'pausiert');
    }
    function forceUpdate() {
      pollOnce();
      fetchLastHourClose();
      fetchFearGreed();
      updateSMAZonesAndATH();
      if (pushEnabled) sendNotification('Daten aktualisiert', `Spot: $${currentPrice.toLocaleString()}`);
      const btn = document.getElementById('refreshBtn'); const t = btn.innerHTML;
      btn.innerHTML='üîÑ Updating‚Ä¶'; btn.disabled = true; setTimeout(()=>{btn.innerHTML=t; btn.disabled=false;}, 900);
    }

    // ========= Service Worker (Cache‚ÄëFix, Network‚ÄëFirst Navigation) =========
    const SW_CODE = `
      const CACHE_NAME = 'btc-monitor-v2.3';

      self.addEventListener('install', (event) => {
        self.skipWaiting();
      });

      self.addEventListener('activate', (event) => {
        event.waitUntil((async () => {
          const keys = await caches.keys();
          await Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)));
          self.clients.claim();
        })());
      });

      self.addEventListener('fetch', (event) => {
        const req = event.request;

        // Navigation: network-first
        if (req.mode === 'navigate') {
          event.respondWith((async () => {
            try {
              const fresh = await fetch(req);
              const cache = await caches.open(CACHE_NAME);
              cache.put(req, fresh.clone());
              return fresh;
            } catch (e) {
              const cached = await caches.match(req);
              return cached || Response.error();
            }
          })());
          return;
        }

        // Andere Requests: cache-first, dann network + cache
        event.respondWith((async () => {
          const cached = await caches.match(req);
          if (cached) return cached;
          const fresh = await fetch(req);
          const cache = await caches.open(CACHE_NAME);
          cache.put(req, fresh.clone());
          return fresh;
        })());
      });
    `;
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        const blob = new Blob([SW_CODE], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).then((reg) => {
          reg.update(); // sofort nach Updates suchen
        }).catch(()=>{});
      }
    }

    // ========= Manifest =========
    function generateManifest() {
      const manifest = {
        "name": "BTC Trading Monitor",
        "short_name": "BTC Monitor",
        "description": "GitHub PWA f√ºr BTC Trading mit Live-Updates",
        "start_url": "/",
        "display": "standalone",
        "background_color": "#667eea",
        "theme_color": "#10b981",
        "orientation": "portrait-primary",
        "icons": [
          {
            "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxMGI5ODEiLz4KPHRleHQgeD0iOTYiIHk9IjEwNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjY0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+4oK/PC90ZXh0Pgo8L3N2Zz4K",
            "sizes": "192x192",
            "type": "image/svg+xml"
          },
          {
            "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iNjQiIGZpbGw9IiMxMGI5ODEiLz4KPHRleHQgeD0iMjU2IiB5PSIyODAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNzAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjZmZmZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7igrM8L3RleHQ+Cjwvc3ZnPgo=",
            "sizes": "512x512",
            "type": "image/svg+xml"
          }
        ],
        "categories": ["finance", "productivity", "utilities"],
        "screenshots": [],
        "shortcuts": [
          { "name": "Aktuelle Trigger", "short_name": "Trigger", "description": "Zeige aktuelle Trading Trigger", "url": "/#triggers" }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
      const manifestUrl = URL.createObjectURL(manifestBlob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manifestUrl + '?v=2.3'; // Version-Bust
      document.head.appendChild(link);
    }

    // ========= Events =========
    document.getElementById('pushBtn').addEventListener('click', enablePush);
    document.getElementById('monitorBtn').addEventListener('click', toggleMonitoring);
    document.getElementById('refreshBtn').addEventListener('click', forceUpdate);
    document.getElementById('fedAddBtn').addEventListener('click', () => {
      const ts = document.getElementById('fedInput').value.trim();
      const label = document.getElementById('fedLabel').value.trim() || 'FOMC';
      addFedEvent(ts, label);
      document.getElementById('fedInput').value = ''; document.getElementById('fedLabel').value = '';
    });
    document.getElementById('fedClearBtn').addEventListener('click', () => { saveFedEvents([]); renderFedEvents(); });
    document.getElementById('crashToggle').addEventListener('click', () => {
      crashOn = !crashOn;
      document.getElementById('crashToggle').textContent = crashOn ? '‚úÖ Aktiv' : '‚õî Deaktiviert';
      document.getElementById('crashStatus').textContent = crashOn ? '√úberwacht Preis√§nderungen und sendet Push.' : '√úberwachung aus.';
    });
    document.getElementById('dayToggle').addEventListener('click', () => {
      dayModeOn = !dayModeOn;
      document.getElementById('dayToggle').textContent = dayModeOn ? '‚úÖ Aktiv' : '‚õî Deaktiviert';
      document.getElementById('dayStatus').textContent = dayModeOn ? '5m/15m EMA/RSI/Vol aktiv' : 'Signale aus.';
    });
    document.getElementById('dcaCalcBtn').addEventListener('click', runDCA);
    document.getElementById('ptCalcBtn').addEventListener('click', calcPT);

    // ========= Init =========
    async function init() {
      console.log('BTC Monitor v2.3 init');
      generateManifest();
      registerServiceWorker();

      // Fed‚ÄëTermine initial
      if (loadFedEvents().length === 0) {
        addFedEvent('2025-07-30T14:00:00Z', 'FOMC Meeting'); // Beispiel
      } else {
        renderFedEvents();
      }

      // Countdowns
      updateCountdowns();
      setInterval(()=>{ updateCountdowns(); updateCounter++; }, 1000);

      // Live Daten
      startPriceStream();
      fetchLastHourClose();
      setInterval(fetchLastHourClose, 60*1000);

      // Fear & Greed + SMA/ATH
      fetchFearGreed();
      updateSMAZonesAndATH();
      setInterval(fetchFearGreed, 60*60*1000); // st√ºndlich

      console.log('‚úÖ Systeme online');
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

    // Liste rendern (falls schon vorhanden)
    function renderFedEventsIfAny(){ try{renderFedEvents();}catch{} }
    renderFedEventsIfAny();
  </script>
</body>
</html>
